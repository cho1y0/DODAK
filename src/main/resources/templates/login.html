<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>로그인 - DODAK</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&display=swap" rel="stylesheet">
<link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<link rel="stylesheet" href="/css/style.css">
<link rel="icon" type="image/x-icon" href="/img/휴식하는도닥이.png">
<style>
/* 로그인과 회원가입 버튼의 기본 스타일 */
.login-btn,
.signup-btn {
    /* 폰트 색상을 연한 갈색으로 통일 (#8d6e63) */
    color: #8d6e63 !important;
    /* 테두리 색상 통일 */
    border-color: #8d6e63 !important;
    
    /* 배경색을 투명으로 설정 (기존 .login-btn의 기본 상태) */
    background-color: transparent !important; 
    
    font-weight: 500;
    transition: all 0.2s;
}

/* 로그인과 회원가입 버튼의 호버 시 스타일 통일 */
.login-btn:hover,
.signup-btn:hover {
    /* 배경색을 밝은 베이지색으로 통일 (#f0e6d6) */
    background-color: #f0e6d6 !important; 
    
    /* 폰트 색상 및 테두리 색상 유지 */
    border-color: #8d6e63 !important;
    color: #8d6e63 !important;
}
</style> 
</head>
<body style="padding-top: 0;">

<div class="signup-wrapper"> 
    <div class="signup-card">
        <img src="/img/dodak.png" alt="도닥이 마스코트" style="width: 80px; margin-bottom: 20px;">
        <h2>DODAK 로그인</h2>
        <p class="text-muted mb-4">도닥이가 당신의 이야기를 기다립니다.</p>

        <form action="/loginProc" method="post">
            <div class="mb-3 text-start">
                <label for="inputID" class="form-label-custom">아이디</label>
                <input type="text" class="form-control" id="inputID" name="username" placeholder="아이디 입력" required>
            </div>

            <div class="mb-4 text-start">
                <label for="inputPassword" class="form-label-custom">비밀번호</label>
                <input type="password" class="form-control" id="inputPassword" name="password" placeholder="비밀번호 입력" required>
            </div>

            <button type="submit" class="btn btn-lg w-100 btn-dark login-btn">
               <i class="bi bi-box-arrow-in-right me-2"></i> 로그인
            </button>

            <!-- 비밀번호 찾기 링크 -->
            <div class="text-center mt-3">
               <a href="#" class="text-muted" data-bs-toggle="modal" data-bs-target="#forgotPasswordModal" style="font-size: 0.9rem; text-decoration: none;">
                  <i class="bi bi-key me-1"></i>비밀번호를 잊으셨나요?
               </a>
            </div>

            <div class="d-flex justify-content-between mt-3 gap-3">

               <a href="/join" class="btn btn-lg w-50 login-btn" style="font-size: 1rem;">
                  <i class="bi bi-person-plus-fill me-1"></i> 회원가입
               </a>

               <a href="/" class="btn btn-lg w-50 btn-outline-secondary" style="font-size: 1rem;">
                  <i class="bi bi-arrow-left me-1"></i> 메인으로 돌아가기
               </a>
            </div>
        </form>
    </div>
</div>

<!-- 비밀번호 찾기 모달 -->
<div class="modal fade" id="forgotPasswordModal" tabindex="-1" aria-labelledby="forgotPasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 15px;">
            <div class="modal-header border-0" style="background: linear-gradient(135deg, #8d6e63, #a1887f); border-radius: 15px 15px 0 0;">
                <h5 class="modal-title text-white" id="forgotPasswordModalLabel">
                    <i class="bi bi-key-fill me-2"></i>비밀번호 찾기
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <p class="text-muted mb-4">가입 시 등록한 아이디와 이메일을 입력하시면<br>임시 비밀번호를 이메일로 발송해 드립니다.</p>

                <form id="forgotPasswordForm">
                    <div class="mb-3">
                        <label for="resetUserId" class="form-label">아이디</label>
                        <input type="text" class="form-control" id="resetUserId" placeholder="아이디를 입력하세요" required>
                    </div>
                    <div class="mb-4">
                        <label for="resetEmail" class="form-label">이메일</label>
                        <input type="email" class="form-control" id="resetEmail" placeholder="가입 시 등록한 이메일" required>
                    </div>

                    <div id="resetMessage" class="alert d-none mb-3" role="alert"></div>

                    <button type="submit" class="btn w-100 login-btn" id="resetSubmitBtn">
                        <i class="bi bi-envelope me-2"></i>임시 비밀번호 발송
                    </button>
                </form>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <small class="text-muted">임시 비밀번호로 로그인 후 꼭 비밀번호를 변경하세요.</small>
            </div>
        </div>
    </div>
</div>

<script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
        // 현재 URL의 쿼리 파라미터에 'error'가 있는지 확인합니다.
        const urlParams = new URLSearchParams(window.location.search);
        
        // Security 설정에 의해 로그인 실패 시 URL은 /login?error 가 됩니다.
        if (urlParams.has('error')) {
            alert("⚠️ 아이디 또는 비밀번호가 일치하지 않습니다.");
            
            // 경고창을 띄운 후 URL에서 ?error 파라미터를 제거하여 새로고침 시 다시 뜨는 것을 방지
            // (히스토리 관리를 위해 replaceState 사용)
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        // 비밀번호 찾기 폼 처리
        document.getElementById('forgotPasswordForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const userId = document.getElementById('resetUserId').value.trim();
            const email = document.getElementById('resetEmail').value.trim();
            const messageDiv = document.getElementById('resetMessage');
            const submitBtn = document.getElementById('resetSubmitBtn');

            // 버튼 비활성화 및 로딩 표시
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>발송 중...';

            // 메시지 초기화
            messageDiv.classList.add('d-none');
            messageDiv.classList.remove('alert-success', 'alert-danger');

            fetch('/api/password/reset', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    userId: userId,
                    email: email
                })
            })
            .then(response => response.json())
            .then(data => {
                messageDiv.classList.remove('d-none');

                if (data.success) {
                    messageDiv.classList.add('alert-success');
                    messageDiv.innerHTML = '<i class="bi bi-check-circle me-2"></i>' + data.message;

                    // 폼 초기화
                    document.getElementById('forgotPasswordForm').reset();

                    // 3초 후 모달 닫기
                    setTimeout(function() {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('forgotPasswordModal'));
                        modal.hide();
                        messageDiv.classList.add('d-none');
                    }, 3000);
                } else {
                    messageDiv.classList.add('alert-danger');
                    messageDiv.innerHTML = '<i class="bi bi-exclamation-circle me-2"></i>' + data.message;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                messageDiv.classList.remove('d-none');
                messageDiv.classList.add('alert-danger');
                messageDiv.innerHTML = '<i class="bi bi-exclamation-circle me-2"></i>오류가 발생했습니다. 잠시 후 다시 시도해주세요.';
            })
            .finally(() => {
                // 버튼 원래대로 복원
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-envelope me-2"></i>임시 비밀번호 발송';
            });
        });

        // 모달이 닫힐 때 폼과 메시지 초기화
        document.getElementById('forgotPasswordModal').addEventListener('hidden.bs.modal', function() {
            document.getElementById('forgotPasswordForm').reset();
            const messageDiv = document.getElementById('resetMessage');
            messageDiv.classList.add('d-none');
            messageDiv.classList.remove('alert-success', 'alert-danger');
        });
    </script>
</body>
</html>